73cc4bbff7ab1ded1cbc8d0e4ce96751
"use strict";

/* istanbul ignore next */
function cov_1wcain31u1() {
  var path = "/home/hager/new/my-nextjs-project-master (3)/my-nextjs-project-master/lib/api/services/fulfillment.ts";
  var hash = "e4cd24f5b7ed4360d1ffa0a02c652b60c434c9d1";
  var global = new Function("return this")();
  var gcv = "__coverage__";
  var coverageData = {
    path: "/home/hager/new/my-nextjs-project-master (3)/my-nextjs-project-master/lib/api/services/fulfillment.ts",
    statementMap: {
      "0": {
        start: {
          line: 2,
          column: 0
        },
        end: {
          line: 4,
          column: 3
        }
      },
      "1": {
        start: {
          line: 5,
          column: 0
        },
        end: {
          line: 10,
          column: 3
        }
      },
      "2": {
        start: {
          line: 8,
          column: 8
        },
        end: {
          line: 8,
          column: 34
        }
      },
      "3": {
        start: {
          line: 11,
          column: 17
        },
        end: {
          line: 11,
          column: 59
        }
      },
      "4": {
        start: {
          line: 12,
          column: 18
        },
        end: {
          line: 12,
          column: 59
        }
      },
      "5": {
        start: {
          line: 13,
          column: 27
        },
        end: {
          line: 13,
          column: 59
        }
      },
      "6": {
        start: {
          line: 14,
          column: 34
        },
        end: {
          line: 14,
          column: 98
        }
      },
      "7": {
        start: {
          line: 16,
          column: 4
        },
        end: {
          line: 18,
          column: 6
        }
      },
      "8": {
        start: {
          line: 22,
          column: 8
        },
        end: {
          line: 22,
          column: 67
        }
      },
      "9": {
        start: {
          line: 23,
          column: 8
        },
        end: {
          line: 23,
          column: 71
        }
      },
      "10": {
        start: {
          line: 26,
          column: 8
        },
        end: {
          line: 44,
          column: 9
        }
      },
      "11": {
        start: {
          line: 27,
          column: 26
        },
        end: {
          line: 27,
          column: 69
        }
      },
      "12": {
        start: {
          line: 28,
          column: 12
        },
        end: {
          line: 30,
          column: 13
        }
      },
      "13": {
        start: {
          line: 29,
          column: 16
        },
        end: {
          line: 29,
          column: 51
        }
      },
      "14": {
        start: {
          line: 31,
          column: 12
        },
        end: {
          line: 40,
          column: 13
        }
      },
      "15": {
        start: {
          line: 33,
          column: 20
        },
        end: {
          line: 33,
          column: 73
        }
      },
      "16": {
        start: {
          line: 35,
          column: 20
        },
        end: {
          line: 35,
          column: 74
        }
      },
      "17": {
        start: {
          line: 37,
          column: 20
        },
        end: {
          line: 37,
          column: 74
        }
      },
      "18": {
        start: {
          line: 39,
          column: 20
        },
        end: {
          line: 39,
          column: 64
        }
      },
      "19": {
        start: {
          line: 42,
          column: 12
        },
        end: {
          line: 42,
          column: 64
        }
      },
      "20": {
        start: {
          line: 43,
          column: 12
        },
        end: {
          line: 43,
          column: 24
        }
      },
      "21": {
        start: {
          line: 48,
          column: 26
        },
        end: {
          line: 48,
          column: 94
        }
      },
      "22": {
        start: {
          line: 48,
          column: 84
        },
        end: {
          line: 48,
          column: 92
        }
      },
      "23": {
        start: {
          line: 49,
          column: 8
        },
        end: {
          line: 51,
          column: 9
        }
      },
      "24": {
        start: {
          line: 50,
          column: 12
        },
        end: {
          line: 50,
          column: 68
        }
      },
      "25": {
        start: {
          line: 53,
          column: 28
        },
        end: {
          line: 65,
          column: 10
        }
      },
      "26": {
        start: {
          line: 61,
          column: 44
        },
        end: {
          line: 64,
          column: 17
        }
      },
      "27": {
        start: {
          line: 67,
          column: 8
        },
        end: {
          line: 71,
          column: 11
        }
      },
      "28": {
        start: {
          line: 73,
          column: 8
        },
        end: {
          line: 78,
          column: 11
        }
      },
      "29": {
        start: {
          line: 79,
          column: 8
        },
        end: {
          line: 86,
          column: 10
        }
      },
      "30": {
        start: {
          line: 89,
          column: 8
        },
        end: {
          line: 105,
          column: 9
        }
      },
      "31": {
        start: {
          line: 90,
          column: 12
        },
        end: {
          line: 101,
          column: 13
        }
      },
      "32": {
        start: {
          line: 92,
          column: 41
        },
        end: {
          line: 92,
          column: 96
        }
      },
      "33": {
        start: {
          line: 93,
          column: 20
        },
        end: {
          line: 96,
          column: 22
        }
      },
      "34": {
        start: {
          line: 98,
          column: 20
        },
        end: {
          line: 98,
          column: 76
        }
      },
      "35": {
        start: {
          line: 100,
          column: 20
        },
        end: {
          line: 100,
          column: 64
        }
      },
      "36": {
        start: {
          line: 103,
          column: 12
        },
        end: {
          line: 103,
          column: 60
        }
      },
      "37": {
        start: {
          line: 104,
          column: 12
        },
        end: {
          line: 104,
          column: 24
        }
      },
      "38": {
        start: {
          line: 108,
          column: 8
        },
        end: {
          line: 111,
          column: 11
        }
      },
      "39": {
        start: {
          line: 109,
          column: 34
        },
        end: {
          line: 109,
          column: 116
        }
      },
      "40": {
        start: {
          line: 109,
          column: 56
        },
        end: {
          line: 109,
          column: 115
        }
      },
      "41": {
        start: {
          line: 110,
          column: 12
        },
        end: {
          line: 110,
          column: 85
        }
      }
    },
    fnMap: {
      "0": {
        name: "(anonymous_0)",
        decl: {
          start: {
            line: 7,
            column: 9
          },
          end: {
            line: 7,
            column: 10
          }
        },
        loc: {
          start: {
            line: 7,
            column: 20
          },
          end: {
            line: 9,
            column: 5
          }
        },
        line: 7
      },
      "1": {
        name: "_interop_require_default",
        decl: {
          start: {
            line: 15,
            column: 9
          },
          end: {
            line: 15,
            column: 33
          }
        },
        loc: {
          start: {
            line: 15,
            column: 39
          },
          end: {
            line: 19,
            column: 1
          }
        },
        line: 15
      },
      "2": {
        name: "(anonymous_2)",
        decl: {
          start: {
            line: 21,
            column: 4
          },
          end: {
            line: 21,
            column: 5
          }
        },
        loc: {
          start: {
            line: 21,
            column: 23
          },
          end: {
            line: 24,
            column: 5
          }
        },
        line: 21
      },
      "3": {
        name: "(anonymous_3)",
        decl: {
          start: {
            line: 25,
            column: 4
          },
          end: {
            line: 25,
            column: 5
          }
        },
        loc: {
          start: {
            line: 25,
            column: 41
          },
          end: {
            line: 45,
            column: 5
          }
        },
        line: 25
      },
      "4": {
        name: "(anonymous_4)",
        decl: {
          start: {
            line: 46,
            column: 4
          },
          end: {
            line: 46,
            column: 5
          }
        },
        loc: {
          start: {
            line: 46,
            column: 51
          },
          end: {
            line: 87,
            column: 5
          }
        },
        line: 46
      },
      "5": {
        name: "(anonymous_5)",
        decl: {
          start: {
            line: 48,
            column: 76
          },
          end: {
            line: 48,
            column: 77
          }
        },
        loc: {
          start: {
            line: 48,
            column: 84
          },
          end: {
            line: 48,
            column: 92
          }
        },
        line: 48
      },
      "6": {
        name: "(anonymous_6)",
        decl: {
          start: {
            line: 61,
            column: 35
          },
          end: {
            line: 61,
            column: 36
          }
        },
        loc: {
          start: {
            line: 61,
            column: 44
          },
          end: {
            line: 64,
            column: 17
          }
        },
        line: 61
      },
      "7": {
        name: "(anonymous_7)",
        decl: {
          start: {
            line: 88,
            column: 4
          },
          end: {
            line: 88,
            column: 5
          }
        },
        loc: {
          start: {
            line: 88,
            column: 51
          },
          end: {
            line: 106,
            column: 5
          }
        },
        line: 88
      },
      "8": {
        name: "(anonymous_8)",
        decl: {
          start: {
            line: 107,
            column: 4
          },
          end: {
            line: 107,
            column: 5
          }
        },
        loc: {
          start: {
            line: 107,
            column: 44
          },
          end: {
            line: 112,
            column: 5
          }
        },
        line: 107
      },
      "9": {
        name: "(anonymous_9)",
        decl: {
          start: {
            line: 108,
            column: 27
          },
          end: {
            line: 108,
            column: 28
          }
        },
        loc: {
          start: {
            line: 108,
            column: 35
          },
          end: {
            line: 111,
            column: 9
          }
        },
        line: 108
      },
      "10": {
        name: "(anonymous_10)",
        decl: {
          start: {
            line: 109,
            column: 49
          },
          end: {
            line: 109,
            column: 50
          }
        },
        loc: {
          start: {
            line: 109,
            column: 56
          },
          end: {
            line: 109,
            column: 115
          }
        },
        line: 109
      }
    },
    branchMap: {
      "0": {
        loc: {
          start: {
            line: 16,
            column: 11
          },
          end: {
            line: 18,
            column: 5
          }
        },
        type: "cond-expr",
        locations: [{
          start: {
            line: 16,
            column: 35
          },
          end: {
            line: 16,
            column: 38
          }
        }, {
          start: {
            line: 16,
            column: 41
          },
          end: {
            line: 18,
            column: 5
          }
        }],
        line: 16
      },
      "1": {
        loc: {
          start: {
            line: 16,
            column: 11
          },
          end: {
            line: 16,
            column: 32
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 16,
            column: 11
          },
          end: {
            line: 16,
            column: 14
          }
        }, {
          start: {
            line: 16,
            column: 18
          },
          end: {
            line: 16,
            column: 32
          }
        }],
        line: 16
      },
      "2": {
        loc: {
          start: {
            line: 28,
            column: 12
          },
          end: {
            line: 30,
            column: 13
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 28,
            column: 12
          },
          end: {
            line: 30,
            column: 13
          }
        }, {
          start: {
            line: undefined,
            column: undefined
          },
          end: {
            line: undefined,
            column: undefined
          }
        }],
        line: 28
      },
      "3": {
        loc: {
          start: {
            line: 31,
            column: 12
          },
          end: {
            line: 40,
            column: 13
          }
        },
        type: "switch",
        locations: [{
          start: {
            line: 32,
            column: 16
          },
          end: {
            line: 33,
            column: 73
          }
        }, {
          start: {
            line: 34,
            column: 16
          },
          end: {
            line: 35,
            column: 74
          }
        }, {
          start: {
            line: 36,
            column: 16
          },
          end: {
            line: 37,
            column: 74
          }
        }, {
          start: {
            line: 38,
            column: 16
          },
          end: {
            line: 39,
            column: 64
          }
        }],
        line: 31
      },
      "4": {
        loc: {
          start: {
            line: 49,
            column: 8
          },
          end: {
            line: 51,
            column: 9
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 49,
            column: 8
          },
          end: {
            line: 51,
            column: 9
          }
        }, {
          start: {
            line: undefined,
            column: undefined
          },
          end: {
            line: undefined,
            column: undefined
          }
        }],
        line: 49
      },
      "5": {
        loc: {
          start: {
            line: 59,
            column: 35
          },
          end: {
            line: 59,
            column: 80
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 59,
            column: 35
          },
          end: {
            line: 59,
            column: 66
          }
        }, {
          start: {
            line: 59,
            column: 70
          },
          end: {
            line: 59,
            column: 80
          }
        }],
        line: 59
      },
      "6": {
        loc: {
          start: {
            line: 90,
            column: 12
          },
          end: {
            line: 101,
            column: 13
          }
        },
        type: "switch",
        locations: [{
          start: {
            line: 91,
            column: 16
          },
          end: {
            line: 96,
            column: 22
          }
        }, {
          start: {
            line: 97,
            column: 16
          },
          end: {
            line: 98,
            column: 76
          }
        }, {
          start: {
            line: 99,
            column: 16
          },
          end: {
            line: 100,
            column: 64
          }
        }],
        line: 90
      },
      "7": {
        loc: {
          start: {
            line: 109,
            column: 56
          },
          end: {
            line: 109,
            column: 115
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 109,
            column: 56
          },
          end: {
            line: 109,
            column: 76
          }
        }, {
          start: {
            line: 109,
            column: 80
          },
          end: {
            line: 109,
            column: 115
          }
        }],
        line: 109
      },
      "8": {
        loc: {
          start: {
            line: 110,
            column: 19
          },
          end: {
            line: 110,
            column: 84
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 110,
            column: 19
          },
          end: {
            line: 110,
            column: 32
          }
        }, {
          start: {
            line: 110,
            column: 36
          },
          end: {
            line: 110,
            column: 84
          }
        }],
        line: 110
      }
    },
    s: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0,
      "5": 0,
      "6": 0,
      "7": 0,
      "8": 0,
      "9": 0,
      "10": 0,
      "11": 0,
      "12": 0,
      "13": 0,
      "14": 0,
      "15": 0,
      "16": 0,
      "17": 0,
      "18": 0,
      "19": 0,
      "20": 0,
      "21": 0,
      "22": 0,
      "23": 0,
      "24": 0,
      "25": 0,
      "26": 0,
      "27": 0,
      "28": 0,
      "29": 0,
      "30": 0,
      "31": 0,
      "32": 0,
      "33": 0,
      "34": 0,
      "35": 0,
      "36": 0,
      "37": 0,
      "38": 0,
      "39": 0,
      "40": 0,
      "41": 0
    },
    f: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0,
      "5": 0,
      "6": 0,
      "7": 0,
      "8": 0,
      "9": 0,
      "10": 0
    },
    b: {
      "0": [0, 0],
      "1": [0, 0],
      "2": [0, 0],
      "3": [0, 0, 0, 0],
      "4": [0, 0],
      "5": [0, 0],
      "6": [0, 0, 0],
      "7": [0, 0],
      "8": [0, 0]
    },
    inputSourceMap: {
      version: 3,
      sources: ["/home/hager/new/my-nextjs-project-master (3)/my-nextjs-project-master/lib/api/services/fulfillment.ts"],
      sourcesContent: ["import { ShipBobService } from '../integrations/shipbob/service';\nimport { AmazonFBAService } from '../integrations/amazon/service';\nimport { WebhookDispatcher } from '../webhook-dispatcher';\nimport Order from '@/lib/db/models/order.model';\n\nexport class FulfillmentService {\n  private shipbob: ShipBobService;\n  private amazonFBA: AmazonFBAService;\n\n  constructor(config: {\n    shipbob: {\n      apiKey: string;\n      apiUrl: string;\n    };\n    amazon: {\n      region: string;\n      refreshToken: string;\n      accessKeyId: string;\n      secretAccessKey: string;\n      roleArn: string;\n    };\n    shopify?: {\n      apiKey: string;\n      apiSecret: string;\n      domain: string;\n      accessToken: string;\n    };\n  }) {\n    this.shipbob = new ShipBobService(config.shipbob);\n    this.amazonFBA = new AmazonFBAService(config.amazon);\n  }\n\n  async processOrder(orderId: string, options: {\n    fulfillmentType: 'shipbob' | 'amazon' | 'shopify';\n    priority?: 'standard' | 'expedited' | 'priority';\n  }) {\n    try {\n      const order = await Order.findById(orderId);\n      if (!order) {\n        throw new Error('Order not found');\n      }\n\n      switch (options.fulfillmentType) {\n        case 'amazon':\n          return this.processAmazonFulfillment(order, options);\n        case 'shipbob':\n          return this.processShipBobFulfillment(order, options);\n        case 'shopify':\n          return this.processShopifyFulfillment(order, options);\n        default:\n          throw new Error('Invalid fulfillment type');\n      }\n    } catch (error) {\n      console.error('Fulfillment process failed:', error);\n      throw error;\n    }\n  }\n\n  private async processAmazonFulfillment(order: any, options: any) {\n    // Check inventory availability in Amazon FBA\n    const inventory = await this.amazonFBA.getInventory(\n      order.items.map((item: any) => item.sku)\n    );\n\n    if (!this.hasAvailableInventory(inventory, order.items)) {\n      throw new Error('Insufficient inventory in Amazon FBA');\n    }\n\n    // Create Amazon FBA fulfillment order\n    const amazonOrder = await this.amazonFBA.createFulfillmentOrder({\n      amazonOrderId: order.id,\n      sellerOrderId: order.id,\n      fulfillmentAction: 'Ship',\n      displayableOrderId: order.id,\n      displayableOrderDate: new Date().toISOString(),\n      shippingSpeedCategory: options.priority?.toUpperCase() || 'STANDARD',\n      destinationAddress: order.shippingAddress,\n      items: order.items.map((item: any) => ({\n        sellerSku: item.sku,\n        quantity: item.quantity\n      }))\n    });\n\n    // Update order status\n    await Order.findByIdAndUpdate(order.id, {\n      fulfillmentStatus: 'processing',\n      fulfillmentId: amazonOrder.fulfillmentOrderId,\n      fulfillmentType: 'amazon'\n    });\n\n    // Dispatch webhook\n    await WebhookDispatcher.dispatch(\n      order.userId,\n      'order.fulfillment.created',\n      {\n        orderId: order.id,\n        fulfillmentId: amazonOrder.fulfillmentOrderId,\n        fulfillmentType: 'amazon',\n        status: 'processing'\n      }\n    );\n\n    return {\n      success: true,\n      data: {\n        fulfillmentId: amazonOrder.fulfillmentOrderId,\n        status: 'processing',\n        provider: 'amazon'\n      }\n    };\n  }\n\n  async trackFulfillment(fulfillmentId: string, options: {\n    type: 'shipbob' | 'amazon' | 'shopify'\n  }) {\n    try {\n      switch (options.type) {\n        case 'amazon':\n          const amazonStatus = await this.amazonFBA.getFulfillmentOrder(fulfillmentId);\n          return {\n            success: true,\n            data: amazonStatus\n          };\n        case 'shipbob':\n          return this.shipbob.getFulfillmentStatus(fulfillmentId);\n        default:\n          throw new Error('Invalid fulfillment type');\n      }\n    } catch (error) {\n      console.error('Tracking update failed:', error);\n      throw error;\n    }\n  }\n\n  private hasAvailableInventory(inventory: any[], items: any[]) {\n    return items.every(item => {\n      const itemInventory = inventory.find(inv => \n        inv.sku === item.sku || inv.reference_id === item.productId\n      );\n      return itemInventory && itemInventory.availableQuantity >= item.quantity;\n    });\n  }\n}"],
      names: ["FulfillmentService", "constructor", "config", "shipbob", "ShipBobService", "amazonFBA", "AmazonFBAService", "amazon", "processOrder", "orderId", "options", "order", "Order", "findById", "Error", "fulfillmentType", "processAmazonFulfillment", "processShipBobFulfillment", "processShopifyFulfillment", "error", "console", "inventory", "getInventory", "items", "map", "item", "sku", "hasAvailableInventory", "amazonOrder", "createFulfillmentOrder", "amazonOrderId", "id", "sellerOrderId", "fulfillmentAction", "displayableOrderId", "displayableOrderDate", "Date", "toISOString", "shippingSpeedCategory", "priority", "toUpperCase", "destinationAddress", "shippingAddress", "sellerSku", "quantity", "findByIdAndUpdate", "fulfillmentStatus", "fulfillmentId", "fulfillmentOrderId", "WebhookDispatcher", "dispatch", "userId", "status", "success", "data", "provider", "trackFulfillment", "type", "amazonStatus", "getFulfillmentOrder", "getFulfillmentStatus", "every", "itemInventory", "find", "inv", "reference_id", "productId", "availableQuantity"],
      mappings: ";;;;+BAKaA;;;eAAAA;;;yBALkB;0BACE;mCACC;mEAChB;;;;;;AAEX,MAAMA;IAIXC,YAAYC,MAkBX,CAAE;QACD,IAAI,CAACC,OAAO,GAAG,IAAIC,uBAAc,CAACF,OAAOC,OAAO;QAChD,IAAI,CAACE,SAAS,GAAG,IAAIC,0BAAgB,CAACJ,OAAOK,MAAM;IACrD;IAEA,MAAMC,aAAaC,OAAe,EAAEC,OAGnC,EAAE;QACD,IAAI;YACF,MAAMC,QAAQ,MAAMC,mBAAK,CAACC,QAAQ,CAACJ;YACnC,IAAI,CAACE,OAAO;gBACV,MAAM,IAAIG,MAAM;YAClB;YAEA,OAAQJ,QAAQK,eAAe;gBAC7B,KAAK;oBACH,OAAO,IAAI,CAACC,wBAAwB,CAACL,OAAOD;gBAC9C,KAAK;oBACH,OAAO,IAAI,CAACO,yBAAyB,CAACN,OAAOD;gBAC/C,KAAK;oBACH,OAAO,IAAI,CAACQ,yBAAyB,CAACP,OAAOD;gBAC/C;oBACE,MAAM,IAAII,MAAM;YACpB;QACF,EAAE,OAAOK,OAAO;YACdC,QAAQD,KAAK,CAAC,+BAA+BA;YAC7C,MAAMA;QACR;IACF;IAEA,MAAcH,yBAAyBL,KAAU,EAAED,OAAY,EAAE;QAC/D,6CAA6C;QAC7C,MAAMW,YAAY,MAAM,IAAI,CAAChB,SAAS,CAACiB,YAAY,CACjDX,MAAMY,KAAK,CAACC,GAAG,CAAC,CAACC,OAAcA,KAAKC,GAAG;QAGzC,IAAI,CAAC,IAAI,CAACC,qBAAqB,CAACN,WAAWV,MAAMY,KAAK,GAAG;YACvD,MAAM,IAAIT,MAAM;QAClB;QAEA,sCAAsC;QACtC,MAAMc,cAAc,MAAM,IAAI,CAACvB,SAAS,CAACwB,sBAAsB,CAAC;YAC9DC,eAAenB,MAAMoB,EAAE;YACvBC,eAAerB,MAAMoB,EAAE;YACvBE,mBAAmB;YACnBC,oBAAoBvB,MAAMoB,EAAE;YAC5BI,sBAAsB,IAAIC,OAAOC,WAAW;YAC5CC,uBAAuB5B,QAAQ6B,QAAQ,EAAEC,iBAAiB;YAC1DC,oBAAoB9B,MAAM+B,eAAe;YACzCnB,OAAOZ,MAAMY,KAAK,CAACC,GAAG,CAAC,CAACC,OAAe,CAAA;oBACrCkB,WAAWlB,KAAKC,GAAG;oBACnBkB,UAAUnB,KAAKmB,QAAQ;gBACzB,CAAA;QACF;QAEA,sBAAsB;QACtB,MAAMhC,mBAAK,CAACiC,iBAAiB,CAAClC,MAAMoB,EAAE,EAAE;YACtCe,mBAAmB;YACnBC,eAAenB,YAAYoB,kBAAkB;YAC7CjC,iBAAiB;QACnB;QAEA,mBAAmB;QACnB,MAAMkC,oCAAiB,CAACC,QAAQ,CAC9BvC,MAAMwC,MAAM,EACZ,6BACA;YACE1C,SAASE,MAAMoB,EAAE;YACjBgB,eAAenB,YAAYoB,kBAAkB;YAC7CjC,iBAAiB;YACjBqC,QAAQ;QACV;QAGF,OAAO;YACLC,SAAS;YACTC,MAAM;gBACJP,eAAenB,YAAYoB,kBAAkB;gBAC7CI,QAAQ;gBACRG,UAAU;YACZ;QACF;IACF;IAEA,MAAMC,iBAAiBT,aAAqB,EAAErC,OAE7C,EAAE;QACD,IAAI;YACF,OAAQA,QAAQ+C,IAAI;gBAClB,KAAK;oBACH,MAAMC,eAAe,MAAM,IAAI,CAACrD,SAAS,CAACsD,mBAAmB,CAACZ;oBAC9D,OAAO;wBACLM,SAAS;wBACTC,MAAMI;oBACR;gBACF,KAAK;oBACH,OAAO,IAAI,CAACvD,OAAO,CAACyD,oBAAoB,CAACb;gBAC3C;oBACE,MAAM,IAAIjC,MAAM;YACpB;QACF,EAAE,OAAOK,OAAO;YACdC,QAAQD,KAAK,CAAC,2BAA2BA;YACzC,MAAMA;QACR;IACF;IAEQQ,sBAAsBN,SAAgB,EAAEE,KAAY,EAAE;QAC5D,OAAOA,MAAMsC,KAAK,CAACpC,CAAAA;YACjB,MAAMqC,gBAAgBzC,UAAU0C,IAAI,CAACC,CAAAA,MACnCA,IAAItC,GAAG,KAAKD,KAAKC,GAAG,IAAIsC,IAAIC,YAAY,KAAKxC,KAAKyC,SAAS;YAE7D,OAAOJ,iBAAiBA,cAAcK,iBAAiB,IAAI1C,KAAKmB,QAAQ;QAC1E;IACF;AACF"
    },
    _coverageSchema: "1a1c01bbd47fc00a2c39e90264f33305004495a9",
    hash: "e4cd24f5b7ed4360d1ffa0a02c652b60c434c9d1"
  };
  var coverage = global[gcv] || (global[gcv] = {});
  if (!coverage[path] || coverage[path].hash !== hash) {
    coverage[path] = coverageData;
  }
  var actualCoverage = coverage[path];
  {
    // @ts-ignore
    cov_1wcain31u1 = function () {
      return actualCoverage;
    };
  }
  return actualCoverage;
}
cov_1wcain31u1();
cov_1wcain31u1().s[0]++;
Object.defineProperty(exports, "__esModule", {
  value: true
});
/* istanbul ignore next */
cov_1wcain31u1().s[1]++;
Object.defineProperty(exports, "FulfillmentService", {
  enumerable: true,
  get: function () {
    /* istanbul ignore next */
    cov_1wcain31u1().f[0]++;
    cov_1wcain31u1().s[2]++;
    return FulfillmentService;
  }
});
const _service =
/* istanbul ignore next */
(cov_1wcain31u1().s[3]++, require("../integrations/shipbob/service"));
const _service1 =
/* istanbul ignore next */
(cov_1wcain31u1().s[4]++, require("../integrations/amazon/service"));
const _webhookdispatcher =
/* istanbul ignore next */
(cov_1wcain31u1().s[5]++, require("../webhook-dispatcher"));
const _ordermodel =
/* istanbul ignore next */
(/*#__PURE__*/cov_1wcain31u1().s[6]++, _interop_require_default(require("../../db/models/order.model")));
function _interop_require_default(obj) {
  /* istanbul ignore next */
  cov_1wcain31u1().f[1]++;
  cov_1wcain31u1().s[7]++;
  return /* istanbul ignore next */(cov_1wcain31u1().b[1][0]++, obj) &&
  /* istanbul ignore next */
  (cov_1wcain31u1().b[1][1]++, obj.__esModule) ?
  /* istanbul ignore next */
  (cov_1wcain31u1().b[0][0]++, obj) :
  /* istanbul ignore next */
  (cov_1wcain31u1().b[0][1]++, {
    default: obj
  });
}
class FulfillmentService {
  constructor(config) {
    /* istanbul ignore next */
    cov_1wcain31u1().f[2]++;
    cov_1wcain31u1().s[8]++;
    this.shipbob = new _service.ShipBobService(config.shipbob);
    /* istanbul ignore next */
    cov_1wcain31u1().s[9]++;
    this.amazonFBA = new _service1.AmazonFBAService(config.amazon);
  }
  async processOrder(orderId, options) {
    /* istanbul ignore next */
    cov_1wcain31u1().f[3]++;
    cov_1wcain31u1().s[10]++;
    try {
      const order =
      /* istanbul ignore next */
      (cov_1wcain31u1().s[11]++, await _ordermodel.default.findById(orderId));
      /* istanbul ignore next */
      cov_1wcain31u1().s[12]++;
      if (!order) {
        /* istanbul ignore next */
        cov_1wcain31u1().b[2][0]++;
        cov_1wcain31u1().s[13]++;
        throw new Error('Order not found');
      } else
      /* istanbul ignore next */
      {
        cov_1wcain31u1().b[2][1]++;
      }
      cov_1wcain31u1().s[14]++;
      switch (options.fulfillmentType) {
        case 'amazon':
          /* istanbul ignore next */
          cov_1wcain31u1().b[3][0]++;
          cov_1wcain31u1().s[15]++;
          return this.processAmazonFulfillment(order, options);
        case 'shipbob':
          /* istanbul ignore next */
          cov_1wcain31u1().b[3][1]++;
          cov_1wcain31u1().s[16]++;
          return this.processShipBobFulfillment(order, options);
        case 'shopify':
          /* istanbul ignore next */
          cov_1wcain31u1().b[3][2]++;
          cov_1wcain31u1().s[17]++;
          return this.processShopifyFulfillment(order, options);
        default:
          /* istanbul ignore next */
          cov_1wcain31u1().b[3][3]++;
          cov_1wcain31u1().s[18]++;
          throw new Error('Invalid fulfillment type');
      }
    } catch (error) {
      /* istanbul ignore next */
      cov_1wcain31u1().s[19]++;
      console.error('Fulfillment process failed:', error);
      /* istanbul ignore next */
      cov_1wcain31u1().s[20]++;
      throw error;
    }
  }
  async processAmazonFulfillment(order, options) {
    /* istanbul ignore next */
    cov_1wcain31u1().f[4]++;
    // Check inventory availability in Amazon FBA
    const inventory =
    /* istanbul ignore next */
    (cov_1wcain31u1().s[21]++, await this.amazonFBA.getInventory(order.items.map(item => {
      /* istanbul ignore next */
      cov_1wcain31u1().f[5]++;
      cov_1wcain31u1().s[22]++;
      return item.sku;
    })));
    /* istanbul ignore next */
    cov_1wcain31u1().s[23]++;
    if (!this.hasAvailableInventory(inventory, order.items)) {
      /* istanbul ignore next */
      cov_1wcain31u1().b[4][0]++;
      cov_1wcain31u1().s[24]++;
      throw new Error('Insufficient inventory in Amazon FBA');
    } else
    /* istanbul ignore next */
    {
      cov_1wcain31u1().b[4][1]++;
    }
    // Create Amazon FBA fulfillment order
    const amazonOrder =
    /* istanbul ignore next */
    (cov_1wcain31u1().s[25]++, await this.amazonFBA.createFulfillmentOrder({
      amazonOrderId: order.id,
      sellerOrderId: order.id,
      fulfillmentAction: 'Ship',
      displayableOrderId: order.id,
      displayableOrderDate: new Date().toISOString(),
      shippingSpeedCategory:
      /* istanbul ignore next */
      (cov_1wcain31u1().b[5][0]++, options.priority?.toUpperCase()) ||
      /* istanbul ignore next */
      (cov_1wcain31u1().b[5][1]++, 'STANDARD'),
      destinationAddress: order.shippingAddress,
      items: order.items.map(item => {
        /* istanbul ignore next */
        cov_1wcain31u1().f[6]++;
        cov_1wcain31u1().s[26]++;
        return {
          sellerSku: item.sku,
          quantity: item.quantity
        };
      })
    }));
    // Update order status
    /* istanbul ignore next */
    cov_1wcain31u1().s[27]++;
    await _ordermodel.default.findByIdAndUpdate(order.id, {
      fulfillmentStatus: 'processing',
      fulfillmentId: amazonOrder.fulfillmentOrderId,
      fulfillmentType: 'amazon'
    });
    // Dispatch webhook
    /* istanbul ignore next */
    cov_1wcain31u1().s[28]++;
    await _webhookdispatcher.WebhookDispatcher.dispatch(order.userId, 'order.fulfillment.created', {
      orderId: order.id,
      fulfillmentId: amazonOrder.fulfillmentOrderId,
      fulfillmentType: 'amazon',
      status: 'processing'
    });
    /* istanbul ignore next */
    cov_1wcain31u1().s[29]++;
    return {
      success: true,
      data: {
        fulfillmentId: amazonOrder.fulfillmentOrderId,
        status: 'processing',
        provider: 'amazon'
      }
    };
  }
  async trackFulfillment(fulfillmentId, options) {
    /* istanbul ignore next */
    cov_1wcain31u1().f[7]++;
    cov_1wcain31u1().s[30]++;
    try {
      /* istanbul ignore next */
      cov_1wcain31u1().s[31]++;
      switch (options.type) {
        case 'amazon':
          /* istanbul ignore next */
          cov_1wcain31u1().b[6][0]++;
          const amazonStatus =
          /* istanbul ignore next */
          (cov_1wcain31u1().s[32]++, await this.amazonFBA.getFulfillmentOrder(fulfillmentId));
          /* istanbul ignore next */
          cov_1wcain31u1().s[33]++;
          return {
            success: true,
            data: amazonStatus
          };
        case 'shipbob':
          /* istanbul ignore next */
          cov_1wcain31u1().b[6][1]++;
          cov_1wcain31u1().s[34]++;
          return this.shipbob.getFulfillmentStatus(fulfillmentId);
        default:
          /* istanbul ignore next */
          cov_1wcain31u1().b[6][2]++;
          cov_1wcain31u1().s[35]++;
          throw new Error('Invalid fulfillment type');
      }
    } catch (error) {
      /* istanbul ignore next */
      cov_1wcain31u1().s[36]++;
      console.error('Tracking update failed:', error);
      /* istanbul ignore next */
      cov_1wcain31u1().s[37]++;
      throw error;
    }
  }
  hasAvailableInventory(inventory, items) {
    /* istanbul ignore next */
    cov_1wcain31u1().f[8]++;
    cov_1wcain31u1().s[38]++;
    return items.every(item => {
      /* istanbul ignore next */
      cov_1wcain31u1().f[9]++;
      const itemInventory =
      /* istanbul ignore next */
      (cov_1wcain31u1().s[39]++, inventory.find(inv => {
        /* istanbul ignore next */
        cov_1wcain31u1().f[10]++;
        cov_1wcain31u1().s[40]++;
        return /* istanbul ignore next */(cov_1wcain31u1().b[7][0]++, inv.sku === item.sku) ||
        /* istanbul ignore next */
        (cov_1wcain31u1().b[7][1]++, inv.reference_id === item.productId);
      }));
      /* istanbul ignore next */
      cov_1wcain31u1().s[41]++;
      return /* istanbul ignore next */(cov_1wcain31u1().b[8][0]++, itemInventory) &&
      /* istanbul ignore next */
      (cov_1wcain31u1().b[8][1]++, itemInventory.availableQuantity >= item.quantity);
    });
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJGdWxmaWxsbWVudFNlcnZpY2UiLCJjb25zdHJ1Y3RvciIsImNvbmZpZyIsImNvdl8xd2NhaW4zMXUxIiwiZiIsInMiLCJzaGlwYm9iIiwiX3NlcnZpY2UiLCJTaGlwQm9iU2VydmljZSIsImFtYXpvbkZCQSIsIl9zZXJ2aWNlMSIsIkFtYXpvbkZCQVNlcnZpY2UiLCJhbWF6b24iLCJwcm9jZXNzT3JkZXIiLCJvcmRlcklkIiwib3B0aW9ucyIsIm9yZGVyIiwiX29yZGVybW9kZWwiLCJkZWZhdWx0IiwiZmluZEJ5SWQiLCJiIiwiRXJyb3IiLCJmdWxmaWxsbWVudFR5cGUiLCJwcm9jZXNzQW1hem9uRnVsZmlsbG1lbnQiLCJwcm9jZXNzU2hpcEJvYkZ1bGZpbGxtZW50IiwicHJvY2Vzc1Nob3BpZnlGdWxmaWxsbWVudCIsImVycm9yIiwiY29uc29sZSIsImludmVudG9yeSIsImdldEludmVudG9yeSIsIml0ZW1zIiwibWFwIiwiaXRlbSIsInNrdSIsImhhc0F2YWlsYWJsZUludmVudG9yeSIsImFtYXpvbk9yZGVyIiwiY3JlYXRlRnVsZmlsbG1lbnRPcmRlciIsImFtYXpvbk9yZGVySWQiLCJpZCIsInNlbGxlck9yZGVySWQiLCJmdWxmaWxsbWVudEFjdGlvbiIsImRpc3BsYXlhYmxlT3JkZXJJZCIsImRpc3BsYXlhYmxlT3JkZXJEYXRlIiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwic2hpcHBpbmdTcGVlZENhdGVnb3J5IiwicHJpb3JpdHkiLCJ0b1VwcGVyQ2FzZSIsImRlc3RpbmF0aW9uQWRkcmVzcyIsInNoaXBwaW5nQWRkcmVzcyIsInNlbGxlclNrdSIsInF1YW50aXR5IiwiZmluZEJ5SWRBbmRVcGRhdGUiLCJmdWxmaWxsbWVudFN0YXR1cyIsImZ1bGZpbGxtZW50SWQiLCJmdWxmaWxsbWVudE9yZGVySWQiLCJfd2ViaG9va2Rpc3BhdGNoZXIiLCJXZWJob29rRGlzcGF0Y2hlciIsImRpc3BhdGNoIiwidXNlcklkIiwic3RhdHVzIiwic3VjY2VzcyIsImRhdGEiLCJwcm92aWRlciIsInRyYWNrRnVsZmlsbG1lbnQiLCJ0eXBlIiwiYW1hem9uU3RhdHVzIiwiZ2V0RnVsZmlsbG1lbnRPcmRlciIsImdldEZ1bGZpbGxtZW50U3RhdHVzIiwiZXZlcnkiLCJpdGVtSW52ZW50b3J5IiwiZmluZCIsImludiIsInJlZmVyZW5jZV9pZCIsInByb2R1Y3RJZCIsImF2YWlsYWJsZVF1YW50aXR5Il0sInNvdXJjZXMiOlsiL2hvbWUvaGFnZXIvbmV3L215LW5leHRqcy1wcm9qZWN0LW1hc3RlciAoMykvbXktbmV4dGpzLXByb2plY3QtbWFzdGVyL2xpYi9hcGkvc2VydmljZXMvZnVsZmlsbG1lbnQudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2hpcEJvYlNlcnZpY2UgfSBmcm9tICcuLi9pbnRlZ3JhdGlvbnMvc2hpcGJvYi9zZXJ2aWNlJztcbmltcG9ydCB7IEFtYXpvbkZCQVNlcnZpY2UgfSBmcm9tICcuLi9pbnRlZ3JhdGlvbnMvYW1hem9uL3NlcnZpY2UnO1xuaW1wb3J0IHsgV2ViaG9va0Rpc3BhdGNoZXIgfSBmcm9tICcuLi93ZWJob29rLWRpc3BhdGNoZXInO1xuaW1wb3J0IE9yZGVyIGZyb20gJ0AvbGliL2RiL21vZGVscy9vcmRlci5tb2RlbCc7XG5cbmV4cG9ydCBjbGFzcyBGdWxmaWxsbWVudFNlcnZpY2Uge1xuICBwcml2YXRlIHNoaXBib2I6IFNoaXBCb2JTZXJ2aWNlO1xuICBwcml2YXRlIGFtYXpvbkZCQTogQW1hem9uRkJBU2VydmljZTtcblxuICBjb25zdHJ1Y3Rvcihjb25maWc6IHtcbiAgICBzaGlwYm9iOiB7XG4gICAgICBhcGlLZXk6IHN0cmluZztcbiAgICAgIGFwaVVybDogc3RyaW5nO1xuICAgIH07XG4gICAgYW1hem9uOiB7XG4gICAgICByZWdpb246IHN0cmluZztcbiAgICAgIHJlZnJlc2hUb2tlbjogc3RyaW5nO1xuICAgICAgYWNjZXNzS2V5SWQ6IHN0cmluZztcbiAgICAgIHNlY3JldEFjY2Vzc0tleTogc3RyaW5nO1xuICAgICAgcm9sZUFybjogc3RyaW5nO1xuICAgIH07XG4gICAgc2hvcGlmeT86IHtcbiAgICAgIGFwaUtleTogc3RyaW5nO1xuICAgICAgYXBpU2VjcmV0OiBzdHJpbmc7XG4gICAgICBkb21haW46IHN0cmluZztcbiAgICAgIGFjY2Vzc1Rva2VuOiBzdHJpbmc7XG4gICAgfTtcbiAgfSkge1xuICAgIHRoaXMuc2hpcGJvYiA9IG5ldyBTaGlwQm9iU2VydmljZShjb25maWcuc2hpcGJvYik7XG4gICAgdGhpcy5hbWF6b25GQkEgPSBuZXcgQW1hem9uRkJBU2VydmljZShjb25maWcuYW1hem9uKTtcbiAgfVxuXG4gIGFzeW5jIHByb2Nlc3NPcmRlcihvcmRlcklkOiBzdHJpbmcsIG9wdGlvbnM6IHtcbiAgICBmdWxmaWxsbWVudFR5cGU6ICdzaGlwYm9iJyB8ICdhbWF6b24nIHwgJ3Nob3BpZnknO1xuICAgIHByaW9yaXR5PzogJ3N0YW5kYXJkJyB8ICdleHBlZGl0ZWQnIHwgJ3ByaW9yaXR5JztcbiAgfSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBvcmRlciA9IGF3YWl0IE9yZGVyLmZpbmRCeUlkKG9yZGVySWQpO1xuICAgICAgaWYgKCFvcmRlcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ09yZGVyIG5vdCBmb3VuZCcpO1xuICAgICAgfVxuXG4gICAgICBzd2l0Y2ggKG9wdGlvbnMuZnVsZmlsbG1lbnRUeXBlKSB7XG4gICAgICAgIGNhc2UgJ2FtYXpvbic6XG4gICAgICAgICAgcmV0dXJuIHRoaXMucHJvY2Vzc0FtYXpvbkZ1bGZpbGxtZW50KG9yZGVyLCBvcHRpb25zKTtcbiAgICAgICAgY2FzZSAnc2hpcGJvYic6XG4gICAgICAgICAgcmV0dXJuIHRoaXMucHJvY2Vzc1NoaXBCb2JGdWxmaWxsbWVudChvcmRlciwgb3B0aW9ucyk7XG4gICAgICAgIGNhc2UgJ3Nob3BpZnknOlxuICAgICAgICAgIHJldHVybiB0aGlzLnByb2Nlc3NTaG9waWZ5RnVsZmlsbG1lbnQob3JkZXIsIG9wdGlvbnMpO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBmdWxmaWxsbWVudCB0eXBlJyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Z1bGZpbGxtZW50IHByb2Nlc3MgZmFpbGVkOicsIGVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcHJvY2Vzc0FtYXpvbkZ1bGZpbGxtZW50KG9yZGVyOiBhbnksIG9wdGlvbnM6IGFueSkge1xuICAgIC8vIENoZWNrIGludmVudG9yeSBhdmFpbGFiaWxpdHkgaW4gQW1hem9uIEZCQVxuICAgIGNvbnN0IGludmVudG9yeSA9IGF3YWl0IHRoaXMuYW1hem9uRkJBLmdldEludmVudG9yeShcbiAgICAgIG9yZGVyLml0ZW1zLm1hcCgoaXRlbTogYW55KSA9PiBpdGVtLnNrdSlcbiAgICApO1xuXG4gICAgaWYgKCF0aGlzLmhhc0F2YWlsYWJsZUludmVudG9yeShpbnZlbnRvcnksIG9yZGVyLml0ZW1zKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnN1ZmZpY2llbnQgaW52ZW50b3J5IGluIEFtYXpvbiBGQkEnKTtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgQW1hem9uIEZCQSBmdWxmaWxsbWVudCBvcmRlclxuICAgIGNvbnN0IGFtYXpvbk9yZGVyID0gYXdhaXQgdGhpcy5hbWF6b25GQkEuY3JlYXRlRnVsZmlsbG1lbnRPcmRlcih7XG4gICAgICBhbWF6b25PcmRlcklkOiBvcmRlci5pZCxcbiAgICAgIHNlbGxlck9yZGVySWQ6IG9yZGVyLmlkLFxuICAgICAgZnVsZmlsbG1lbnRBY3Rpb246ICdTaGlwJyxcbiAgICAgIGRpc3BsYXlhYmxlT3JkZXJJZDogb3JkZXIuaWQsXG4gICAgICBkaXNwbGF5YWJsZU9yZGVyRGF0ZTogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgc2hpcHBpbmdTcGVlZENhdGVnb3J5OiBvcHRpb25zLnByaW9yaXR5Py50b1VwcGVyQ2FzZSgpIHx8ICdTVEFOREFSRCcsXG4gICAgICBkZXN0aW5hdGlvbkFkZHJlc3M6IG9yZGVyLnNoaXBwaW5nQWRkcmVzcyxcbiAgICAgIGl0ZW1zOiBvcmRlci5pdGVtcy5tYXAoKGl0ZW06IGFueSkgPT4gKHtcbiAgICAgICAgc2VsbGVyU2t1OiBpdGVtLnNrdSxcbiAgICAgICAgcXVhbnRpdHk6IGl0ZW0ucXVhbnRpdHlcbiAgICAgIH0pKVxuICAgIH0pO1xuXG4gICAgLy8gVXBkYXRlIG9yZGVyIHN0YXR1c1xuICAgIGF3YWl0IE9yZGVyLmZpbmRCeUlkQW5kVXBkYXRlKG9yZGVyLmlkLCB7XG4gICAgICBmdWxmaWxsbWVudFN0YXR1czogJ3Byb2Nlc3NpbmcnLFxuICAgICAgZnVsZmlsbG1lbnRJZDogYW1hem9uT3JkZXIuZnVsZmlsbG1lbnRPcmRlcklkLFxuICAgICAgZnVsZmlsbG1lbnRUeXBlOiAnYW1hem9uJ1xuICAgIH0pO1xuXG4gICAgLy8gRGlzcGF0Y2ggd2ViaG9va1xuICAgIGF3YWl0IFdlYmhvb2tEaXNwYXRjaGVyLmRpc3BhdGNoKFxuICAgICAgb3JkZXIudXNlcklkLFxuICAgICAgJ29yZGVyLmZ1bGZpbGxtZW50LmNyZWF0ZWQnLFxuICAgICAge1xuICAgICAgICBvcmRlcklkOiBvcmRlci5pZCxcbiAgICAgICAgZnVsZmlsbG1lbnRJZDogYW1hem9uT3JkZXIuZnVsZmlsbG1lbnRPcmRlcklkLFxuICAgICAgICBmdWxmaWxsbWVudFR5cGU6ICdhbWF6b24nLFxuICAgICAgICBzdGF0dXM6ICdwcm9jZXNzaW5nJ1xuICAgICAgfVxuICAgICk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgZnVsZmlsbG1lbnRJZDogYW1hem9uT3JkZXIuZnVsZmlsbG1lbnRPcmRlcklkLFxuICAgICAgICBzdGF0dXM6ICdwcm9jZXNzaW5nJyxcbiAgICAgICAgcHJvdmlkZXI6ICdhbWF6b24nXG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIHRyYWNrRnVsZmlsbG1lbnQoZnVsZmlsbG1lbnRJZDogc3RyaW5nLCBvcHRpb25zOiB7XG4gICAgdHlwZTogJ3NoaXBib2InIHwgJ2FtYXpvbicgfCAnc2hvcGlmeSdcbiAgfSkge1xuICAgIHRyeSB7XG4gICAgICBzd2l0Y2ggKG9wdGlvbnMudHlwZSkge1xuICAgICAgICBjYXNlICdhbWF6b24nOlxuICAgICAgICAgIGNvbnN0IGFtYXpvblN0YXR1cyA9IGF3YWl0IHRoaXMuYW1hem9uRkJBLmdldEZ1bGZpbGxtZW50T3JkZXIoZnVsZmlsbG1lbnRJZCk7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICBkYXRhOiBhbWF6b25TdGF0dXNcbiAgICAgICAgICB9O1xuICAgICAgICBjYXNlICdzaGlwYm9iJzpcbiAgICAgICAgICByZXR1cm4gdGhpcy5zaGlwYm9iLmdldEZ1bGZpbGxtZW50U3RhdHVzKGZ1bGZpbGxtZW50SWQpO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBmdWxmaWxsbWVudCB0eXBlJyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ1RyYWNraW5nIHVwZGF0ZSBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBoYXNBdmFpbGFibGVJbnZlbnRvcnkoaW52ZW50b3J5OiBhbnlbXSwgaXRlbXM6IGFueVtdKSB7XG4gICAgcmV0dXJuIGl0ZW1zLmV2ZXJ5KGl0ZW0gPT4ge1xuICAgICAgY29uc3QgaXRlbUludmVudG9yeSA9IGludmVudG9yeS5maW5kKGludiA9PiBcbiAgICAgICAgaW52LnNrdSA9PT0gaXRlbS5za3UgfHwgaW52LnJlZmVyZW5jZV9pZCA9PT0gaXRlbS5wcm9kdWN0SWRcbiAgICAgICk7XG4gICAgICByZXR1cm4gaXRlbUludmVudG9yeSAmJiBpdGVtSW52ZW50b3J5LmF2YWlsYWJsZVF1YW50aXR5ID49IGl0ZW0ucXVhbnRpdHk7XG4gICAgfSk7XG4gIH1cbn0iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7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